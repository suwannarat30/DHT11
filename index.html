<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Temperature & Humidity Monitor</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f7f9fc;
      --text: #2a2a2a;
      --card: #ffffff;
      --temp: #ff9b73;
      --hum: #5aa9e6;
      --shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body {
      font-family: 'Kanit', sans-serif;
      background: var(--bg);
      color: var(--text);
      display:flex;
      justify-content:center;
      padding:20px;
    }
    .container {
      max-width: 1100px;
      width: 100%;
      display: grid;
      gap: 20px;
    }
    header {
      text-align:center;
      margin-bottom:10px;
    }
    header h1 {
      font-size: 26px;
      font-weight:700;
      color:#333;
    }
    header p {
      color:#666;
      font-size:14px;
    }

    .cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media(max-width:768px){
      .cards{grid-template-columns:1fr;}
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .big-value {
      font-size: 56px;
      font-weight: 700;
      margin: 10px 0;
    }
    .label {
      font-weight:600;
      font-size:16px;
      color:#555;
    }

    .donut {
      --p:0;
      width:140px;
      height:140px;
      border-radius:50%;
      background:
        conic-gradient(var(--hum) calc(var(--p)*1%), #e4ebf7 0);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:28px;
      font-weight:700;
      color: var(--text);
      position:relative;
    }
    .donut::after{
      content:"";
      position:absolute;
      width:100px;
      height:100px;
      border-radius:50%;
      background:#fff;
    }
    .donut span{
      position:relative;
      z-index:2;
    }

    .status {
      text-align:center;
      padding:10px;
      background:#e4ebf7;
      border-radius:10px;
      font-weight:600;
      margin-top:10px;
    }

    .chart {
      background: var(--card);
      border-radius:16px;
      padding:16px;
      box-shadow: var(--shadow);
    }
    .legend {
      display:flex;
      justify-content:flex-end;
      gap:20px;
      font-size:13px;
      margin-bottom:6px;
    }
    .dot{
      width:12px;height:12px;border-radius:50%;
      display:inline-block;margin-right:6px;
    }
    .dot.t{background:var(--temp);}
    .dot.h{background:var(--hum);}
    canvas{width:100%;height:280px;display:block;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Temperature & Humidity Monitor</h1>
      <p>Real-time Sensor Data</p>
    </header>

    <div class="cards">
      <div class="card">
        <div class="label">üå°Ô∏è Temperature</div>
        <div class="big-value"><span id="temperature-value">--</span>¬∞C</div>
      </div>
      <div class="card">
        <div class="label">üíß Humidity</div>
        <div class="donut" id="humidity-donut" style="--p:0">
          <span id="humidity-value">--%</span>
        </div>
      </div>
    </div>

    <div class="status" id="status-message">Connecting...</div>

    <div class="chart">
      <div class="legend">
        <span><span class="dot t"></span>Temp</span>
        <span><span class="dot h"></span>Humidity</span>
      </div>
      <canvas id="chart"></canvas>
    </div>
  </div>

  <script>
    /* ====== ‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ====== */
    const BACKEND_BASE = "https://dht11-2gtd.onrender.com";
    function setText(id, value){
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    const MAX_POINTS = 60;
    const series = { t: [], h: [], ts: [] };
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    let dpi = 1;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      dpi = window.devicePixelRatio || 1;
      canvas.width = Math.round(rect.width * dpi);
      canvas.height = Math.round(rect.height * dpi);
      drawChart(1);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function lerp(a,b,t){ return a + (b-a)*t; }
    function niceRange(min, max){
      if (min === max) { min -= 1; max += 1; }
      const pad = (max - min) * 0.15;
      return [Math.floor(min - pad), Math.ceil(max + pad)];
    }

    let anim = { fromT:[], toT:[], fromH:[], toH:[], start:0, dur:800 };
    function scheduleAnimation() {
      anim.fromT = anim.toT.slice();
      anim.fromH = anim.toH.slice();
      anim.toT   = series.t.slice();
      anim.toH   = series.h.slice();
      anim.start = performance.now();
      requestAnimationFrame(tick);
    }
    function tick(now){
      const p = Math.min(1, (now - anim.start)/anim.dur);
      drawChart(p);
      if (p < 1) requestAnimationFrame(tick);
    }

    function drawChart(progress=1){
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);
      ctx.save();
      ctx.strokeStyle = 'rgba(0,0,0,.08)';
      ctx.lineWidth = 1;
      const gx=8, gy=5;
      for(let i=1;i<gx;i++){ ctx.beginPath(); ctx.moveTo((w/gx)*i,0); ctx.lineTo((w/gx)*i,h); ctx.stroke(); }
      for(let i=1;i<gy;i++){ ctx.beginPath(); ctx.moveTo(0,(h/gy)*i); ctx.lineTo(w,(h/gy)*i); ctx.stroke(); }
      ctx.restore();

      if (series.t.length < 2) return;
      const minT = Math.min(...series.t), maxT = Math.max(...series.t);
      const minH = Math.min(...series.h), maxH = Math.max(...series.h);
      const [yMinT,yMaxT] = niceRange(minT, maxT);
      const [yMinH,yMaxH] = niceRange(minH, maxH);
      const N = series.t.length;
      const pad = 16 * dpi;
      const plotW = w - pad*2;
      const plotH = h - pad*2;
      const xAt = i => pad + (i/(N-1))*plotW;
      const yAtT = v => pad + (1 - (v - yMinT)/(yMaxT - yMinT))*plotH;
      const yAtH = v => pad + (1 - (v - yMinH)/(yMaxH - yMinH))*plotH;
      const sample = (arrFrom, arrTo, i) => lerp(arrFrom[i] ?? arrTo[i], arrTo[i], progress);

      ctx.save();
      ctx.lineWidth = 3*dpi;
      ctx.strokeStyle = "#ff9b73";
      ctx.beginPath();
      for(let i=0;i<N;i++){ const x=xAt(i); const y=yAtT(sample(anim.fromT,anim.toT,i)); i?ctx.lineTo(x,y):ctx.moveTo(x,y); }
      ctx.stroke(); ctx.restore();

      ctx.save();
      ctx.lineWidth = 3*dpi;
      ctx.strokeStyle = "#5aa9e6";
      ctx.beginPath();
      for(let i=0;i<N;i++){ const x=xAt(i); const y=yAtH(sample(anim.fromH,anim.toH,i)); i?ctx.lineTo(x,y):ctx.moveTo(x,y); }
      ctx.stroke(); ctx.restore();
    }

    function pushPoint(temp, hum){
      const now = Date.now();
      series.t.push(Number(temp));
      series.h.push(Number(hum));
      series.ts.push(now);
      if(series.t.length > MAX_POINTS){ series.t.shift(); series.h.shift(); series.ts.shift(); }
      scheduleAnimation();
    }

    async function fetchData() {
      try {
        const res = await fetch(`${BACKEND_BASE}/data`, { cache: "no-store" });
        const data = await res.json();
        if (data.temperature !== null) {
          const t = Number(data.temperature);
          setText("temperature-value", t.toFixed(1));
          if (!isNaN(t) && data.humidity !== null) {
            pushPoint(t, Number(data.humidity));
          }
        }
        if (data.humidity !== null) {
          const h = Number(data.humidity);
          setText("humidity-value", h.toFixed(0)+"%");
          const donut = document.getElementById('humidity-donut');
          if (donut) donut.style.setProperty('--p', Math.max(0, Math.min(100, h)));
        }
        setText("status-message", "Data updated ‚úÖ");
      } catch (err) {
        console.error("Fetch error:", err);
        setText("status-message", "Error fetching data ‚ö†Ô∏è");
      }
    }

    fetchData();
    setInterval(fetchData, 5000);
  </script>
</body>
</html>
