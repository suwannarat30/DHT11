<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Temperature and Humidity Monitor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ================= THEME TOKENS ================= */
    :root{
      /* Light (default): ‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏ß‡πà‡∏≤‡∏á ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏Ç‡πâ‡∏° */
      --bg1:#e9f0ff;
      --bg2:#cfe3ff;
      --bg3:#9dd1ff;
      --text:#0f172a;
      --muted:rgba(15,23,42,.75);
      --panel:rgba(255,255,255,.75);
      --panel-2:rgba(255,255,255,.82);
      --border:rgba(15,23,42,.10);
      --shadow:0 18px 46px rgba(15,23,42,.18);
      --lineT:#ff9f83;   /* temp line */
      --lineH:#66b9ff;   /* humidity line */
      --statusText:#0b1633;
      --statusBg:rgba(255,255,255,.95);
      --statusBorder:rgba(255,255,255,.98);
      --gridLight:rgba(0,0,0,.12);
      --gridDark:rgba(255,255,255,.15);
    }
    [data-theme="dark"]{
      /* Dark: ‡πÇ‡∏ó‡∏ô‡πÄ‡∏Ç‡πâ‡∏° + ‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏ß‡πà‡∏≤‡∏á/‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏™‡∏ï‡πå‡∏™‡∏π‡∏á */
      --bg1:#0b1220;
      --bg2:#111827;
      --bg3:#1f2937;
      --text:#ffffff;                 /* ‡∏Ç‡∏≤‡∏ß‡∏ä‡∏±‡∏î */
      --muted:rgba(255,255,255,.92);  /* ‡∏ï‡∏±‡∏ß‡∏£‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
      --panel:rgba(255,255,255,.08);
      --panel-2:rgba(255,255,255,.10);
      --border:rgba(255,255,255,.20);
      --shadow:0 22px 50px rgba(0,0,0,.65);
      --lineT:#ffd1c1;
      --lineH:#b7dcff;
      --statusText:#0e1726;
      --statusBg:rgba(255,255,255,.97);
      --statusBorder:rgba(255,255,255,1);
    }

    *{box-sizing:border-box}

    /* ================= BACKGROUND ANIMATION ================= */
    body{
      margin:0; min-height:100vh;
      color:var(--text);
      font-family:'Poppins',system-ui,Segoe UI,Arial,sans-serif;
      display:flex; align-items:center; justify-content:center; padding:20px;
      position:relative; overflow:hidden;
      background: radial-gradient(1200px 900px at 85% -10%, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 60%);
    }
    .bg-anim, .bg-anim::before, .bg-anim::after{
      position:fixed; inset:-20%;
      pointer-events:none; z-index:-2; content:"";
      filter: blur(60px) saturate(120%);
      transform: translateZ(0);
    }
    .bg-anim{
      background:
        radial-gradient(600px 600px at 20% 15%, var(--bg1), transparent 55%),
        radial-gradient(700px 700px at 80% 10%, var(--bg2), transparent 60%),
        radial-gradient(800px 800px at 50% 95%, var(--bg3), transparent 60%);
      animation: drift1 28s ease-in-out infinite alternate;
    }
    .bg-anim::before{
      background:
        radial-gradient(520px 520px at 10% 80%, var(--bg2), transparent 55%),
        radial-gradient(640px 640px at 90% 75%, var(--bg1), transparent 60%);
      animation: drift2 36s ease-in-out infinite alternate;
      opacity:.85;
    }
    .bg-anim::after{
      background: radial-gradient(740px 740px at 50% 50%, rgba(255,255,255,.25), transparent 70%);
      animation: pulse 14s ease-in-out infinite alternate;
      opacity:.28;
    }
    @keyframes drift1{
      0%{transform:translate3d(-2%, -2%, 0) scale(1);}
      100%{transform:translate3d(2%, 1%, 0) scale(1.02);}
    }
    @keyframes drift2{
      0%{transform:translate3d(2%, 3%, 0) scale(1.05);}
      100%{transform:translate3d(-1%, -2%, 0) scale(1.01);}
    }
    @keyframes pulse{
      0%{transform:scale(1);}
      100%{transform:scale(1.06);}
    }

    /* ================= CONTAINER ================= */
    .board{
      width:min(1080px,96vw);
      border-radius:28px; background:var(--panel);
      backdrop-filter: blur(18px) saturate(125%); -webkit-backdrop-filter: blur(18px) saturate(125%);
      border:1px solid var(--border); box-shadow:var(--shadow); overflow:hidden;
      position:relative;
    }

    /* ======= Top bar: ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏ò‡∏µ‡∏° ======= */
    .bar{
      display:flex; align-items:center; justify-content:flex-end;
      gap:10px; padding:14px 16px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,0));
    }
    .theme-toggle{
      display:inline-flex; align-items:center; gap:8px;
      font-weight:700; font-size:13px; color:var(--text);
      background:rgba(255,255,255,.9); border:1px solid rgba(0,0,0,.06);
      padding:6px 10px; border-radius:999px; cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.12);
      user-select:none;
    }
    .theme-toggle input{appearance:none; width:36px; height:20px; border-radius:999px;
      background:#d1d5db; position:relative; outline:none; transition:all .25s ease;}
    .theme-toggle input::after{
      content:""; position:absolute; width:16px; height:16px; border-radius:50%;
      background:#fff; top:2px; left:2px; box-shadow:0 2px 6px rgba(0,0,0,.25);
      transition:transform .25s ease;
    }
    .theme-toggle input:checked{background:#4f46e5;}
    .theme-toggle input:checked::after{transform:translateX(16px);}

    /* ================= LAYOUT & CARDS ================= */
    .grid{display:grid; grid-template-columns: 1.3fr .7fr; gap:18px; padding:18px;}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }

    .main{
      background:var(--panel-2); border:1px solid var(--border); border-radius:22px;
      padding:20px; box-shadow:var(--shadow);
      display:grid; grid-template-columns: 96px 1fr; gap:16px; align-items:center;
      position:relative; overflow:hidden;
    }
    .main::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,0));
      pointer-events:none;
    }
    .icon{
      width:78px;height:78px;border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.24), rgba(255,255,255,.08));
      border:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;
      font-size:40px; box-shadow: inset 0 12px 24px rgba(255,255,255,.15), inset 0 -10px 20px rgba(0,0,0,.15);
    }
    .tempBlock{display:flex;flex-direction:column}
    .tempRow{display:flex;align-items:baseline;gap:10px}
    #temperature-value{
      font-size: clamp(44px, 9vw, 78px);
      font-weight:800; line-height:1; letter-spacing:.4px;
      text-shadow:0 2px 0 rgba(0,0,0,.18);
    }
    .unit{font-weight:700;color:var(--muted)}
    .subtext{margin-top:4px;color:var(--muted);font-weight:600}

    .side{display:flex;flex-direction:column;gap:18px}
    .panel{background:var(--panel-2); border:1px solid var(--border); border-radius:20px; padding:18px; box-shadow:var(--shadow)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .label{font-weight:700;color:var(--muted);display:flex;align-items:center;gap:8px}

    /* ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô */
    .donut{
      --p:0; width:132px;height:132px;border-radius:50%;
      background:
        conic-gradient(var(--lineH) calc(var(--p)*1%), rgba(0,0,0,.10) 0),
        radial-gradient(closest-side, rgba(0,0,0,0) 70%, rgba(255,255,255,.25) 0);
      display:flex;align-items:center;justify-content:center;
      border:1px solid var(--border);
      box-shadow: inset 0 12px 26px rgba(255,255,255,.12), inset 0 -14px 24px rgba(0,0,0,.16);
      transition: background .7s cubic-bezier(.2,.7,.2,1);
    }
    .donut .num{font-size:36px;font-weight:800;text-shadow:0 2px 0 rgba(0,0,0,.25)}
    .donut small{color:var(--muted);font-weight:700;margin-left:4px}

    /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
    #status-message{
      text-align:center; color:var(--statusText);
      background:var(--statusBg);
      border:1px solid var(--statusBorder);
      border-radius:12px; padding:10px 12px; font-weight:600;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      min-width:220px;
    }

    /* ‡∏Å‡∏£‡∏≤‡∏ü */
    .chart-panel{grid-column:1 / -1;}
    .chart-wrap{height:270px; position:relative; border-radius:18px; overflow:hidden}
    canvas{width:100%; height:100%; display:block; filter: drop-shadow(0 10px 22px rgba(0,0,0,.18));}
    .legend{
      position:absolute; top:10px; right:12px; font-size:12px; color:var(--muted); display:flex; gap:12px;
      background:rgba(0,0,0,.12); padding:6px 10px; border-radius:999px; border:1px solid rgba(0,0,0,.08);
      backdrop-filter: blur(6px);
    }
    .dot{width:10px;height:10px;border-radius:50%; box-shadow:0 0 0 2px rgba(255,255,255,.4) inset}
    .t{background:var(--lineT)}
    .h{background:var(--lineH)}

    /* --- Boost readability in Dark mode --- */
    [data-theme="dark"] #temperature-value,
    [data-theme="dark"] .donut .num{
      font-weight:900;
      text-shadow:0 2px 0 rgba(0,0,0,.35);
    }
    [data-theme="dark"] .label,
    [data-theme="dark"] .unit,
    [data-theme="dark"] .subtext{
      color:#e8ecf8;
      font-weight:700;
    }
    [data-theme="dark"] .legend{
      color:#e6eaf5;
      background:rgba(255,255,255,.08);
      border-color:rgba(255,255,255,.18);
    }
    [data-theme="dark"] .icon{
      box-shadow: inset 0 12px 24px rgba(255,255,255,.18), inset 0 -10px 20px rgba(0,0,0,.25);
    }
  </style>
</head>
<body>
  <!-- ‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô -->
  <div class="bg-anim"></div>

  <div class="board">
    <!-- ‡πÅ‡∏ñ‡∏ö‡∏ö‡∏ô: ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏µ‡∏° -->
    <div class="bar">
      <label class="theme-toggle" title="Toggle Light/Dark">
        <span>Light</span>
        <input id="themeSwitch" type="checkbox" aria-label="Toggle theme">
        <span>Dark</span>
      </label>
    </div>

    <div class="grid">
      <!-- Left: Temperature block -->
      <section class="main">
        <div class="icon">‚òÄÔ∏è</div>
        <div class="tempBlock">
          <div class="tempRow">
            <div id="temperature-value">--</div>
            <div class="unit">¬∞C</div>
          </div>
          <div class="subtext">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</div>
        </div>
      </section>

      <!-- Right: Humidity + status -->
      <section class="side">
        <div class="panel">
          <div class="row" style="gap:18px;">
            <div class="label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ó‡∏ò‡πå üíß</div>
            <div class="donut" id="humidity-donut" style="--p:0">
              <span class="num" id="humidity-value">--</span><small>%</small>
            </div>
          </div>
        </div>

        <div class="panel" style="display:flex;justify-content:center;align-items:center;">
          <div id="status-message">Connecting...</div>
        </div>
      </section>

      <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß -->
      <section class="panel chart-panel">
        <div class="chart-wrap">
          <canvas id="chart"></canvas>
          <div class="legend">
            <span style="display:flex;align-items:center;gap:6px"><span class="dot t"></span>Temp</span>
            <span style="display:flex;align-items:center;gap:6px"><span class="dot h"></span>Humidity</span>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    /* ============== Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Polling, ‡∏Å‡∏£‡∏≤‡∏ü, ‡πÇ‡∏î‡∏ô‡∏±‡∏ó) ============== */
    const BACKEND_BASE = "https://dht11-2gtd.onrender.com";

    function setText(id, value){
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    const MAX_POINTS = 60;
    const series = { t: [], h: [], ts: [] };

    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    let dpi = 1;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      dpi = window.devicePixelRatio || 1;
      canvas.width = Math.round(rect.width * dpi);
      canvas.height = Math.round(rect.height * dpi);
      drawChart(1);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function lerp(a,b,t){ return a + (b-a)*t; }
    function niceRange(min, max){
      if (min === max) { min -= 1; max += 1; }
      const pad = (max - min) * 0.15;
      return [Math.floor(min - pad), Math.ceil(max + pad)];
    }

    let anim = { fromT:[], toT:[], fromH:[], toH:[], start:0, dur:800 };
    function scheduleAnimation() {
      anim.fromT = anim.toT.slice();
      anim.fromH = anim.toH.slice();
      anim.toT   = series.t.slice();
      anim.toH   = series.h.slice();
      anim.start = performance.now();
      requestAnimationFrame(tick);
    }
    function tick(now){
      const p = Math.min(1, (now - anim.start)/anim.dur);
      drawChart(p);
      if (p < 1) requestAnimationFrame(tick);
    }

    function drawChart(progress=1){
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      // Grid ‡∏™‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏ò‡∏µ‡∏°
      ctx.save();
      const isDark = document.body.getAttribute('data-theme') === 'dark';
      const gridColor = getComputedStyle(document.documentElement)
        .getPropertyValue(isDark ? '--gridDark' : '--gridLight').trim();
      ctx.strokeStyle = gridColor || (isDark ? 'rgba(255,255,255,.15)' : 'rgba(0,0,0,.12)');
      ctx.lineWidth = 1;
      const gx = 8, gy = 5;
      for(let i=1;i<gx;i++){
        const x = (w/gx)*i;
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
      }
      for(let i=1;i<gy;i++){
        const y = (h/gy)*i;
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }
      ctx.restore();

      if (series.t.length < 2) return;

      const minT = Math.min(...series.t), maxT = Math.max(...series.t);
      const minH = Math.min(...series.h), maxH = Math.max(...series.h);
      const [yMinT,yMaxT] = niceRange(minT, maxT);
      const [yMinH,yMaxH] = niceRange(minH, maxH);

      const N = series.t.length;
      const pad = 16 * dpi;
      const plotW = w - pad*2;
      const plotH = h - pad*2;
      const xAt = i => pad + (i/(N-1))*plotW;
      const yAtT = v => pad + (1 - (v - yMinT)/(yMaxT - yMinT))*plotH;
      const yAtH = v => pad + (1 - (v - yMinH)/(yMaxH - yMinH))*plotH;

      const sample = (arrFrom, arrTo, i) => lerp(arrFrom[i] ?? arrTo[i], arrTo[i], progress);

      // temp
      ctx.save();
      ctx.lineWidth = 3 * dpi;
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--lineT').trim() || '#ffd1c1';
      ctx.beginPath();
      for (let i=0;i<N;i++){
        const x = xAt(i);
        const y = yAtT(sample(anim.fromT, anim.toT, i));
        i? ctx.lineTo(x,y) : ctx.moveTo(x,y);
      }
      ctx.stroke();
      ctx.restore();

      // humidity
      ctx.save();
      ctx.lineWidth = 3 * dpi;
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--lineH').trim() || '#b7dcff';
      ctx.beginPath();
      for (let i=0;i<N;i++){
        const x = xAt(i);
        const y = yAtH(sample(anim.fromH, anim.toH, i));
        i? ctx.lineTo(x,y) : ctx.moveTo(x,y);
      }
      ctx.stroke();
      ctx.restore();
    }

    function pushPoint(temp, hum){
      const now = Date.now();
      series.t.push(Number(temp));
      series.h.push(Number(hum));
      series.ts.push(now);
      if (series.t.length > MAX_POINTS){
        series.t.shift(); series.h.shift(); series.ts.shift();
      }
      scheduleAnimation();
    }

    async function fetchData() {
      try {
        const res = await fetch(`${BACKEND_BASE}/data`, { cache: "no-store" });
        const data = await res.json();

        if (data.temperature !== null) {
          const t = Number(data.temperature);
          setText("temperature-value", t.toFixed(1));
          if (!isNaN(t) && data.humidity !== null) {
            pushPoint(t, Number(data.humidity));
          }
        }
        if (data.humidity !== null) {
          const h = Number(data.humidity);
          setText("humidity-value", h.toFixed(0));
          const donut = document.getElementById('humidity-donut');
          if (donut) donut.style.setProperty('--p', Math.max(0, Math.min(100, h)));
        }
        setText("status-message", "Data updated ‚úÖ");
      } catch (err) {
        console.error("Fetch error:", err);
        setText("status-message", "Error fetching data ‚ö†Ô∏è");
      }
    }

    fetchData();
    setInterval(fetchData, 5000);

    /* ================= THEME TOGGLER ================= */
    const switchEl = document.getElementById('themeSwitch');
    const saved = localStorage.getItem('theme') || 'dark';   // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà Dark
    document.body.setAttribute('data-theme', saved);
    switchEl.checked = saved === 'dark';
    switchEl.addEventListener('change', () => {
      const theme = switchEl.checked ? 'dark' : 'light';
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      drawChart(1); // ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏Å‡∏£‡∏¥‡∏î‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    });
  </script>
</body>
</html>
